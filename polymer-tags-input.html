<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link ref="import" href="../polymer-keydown/polymer-keydown.html"
<!--
`polymer-tags-input`
an input especially for tags

@demo demo/index.html 
-->

<dom-module id="polymer-tags-input">
    <template>
        <style>
            :host {
                display: inline-block;
                padding: 4px;
            }

            .tag {
                background-color: cornflowerblue;
                border-color: black;
                padding: 2px 4px;
                margin-right: 4px;
                color: white;
            }

            #input {
                width: auto;
                display: inline-block;
            }

            /* inspired from: https://codepen.io/sevilayha/pen/IdGKH  */

            .group {
                position: relative;
                margin-bottom: 45px;
                min-width: 200px;
                margin-top: 20px; /* space for the label */
                display: inline-block;
            }

            #inputGroup {
                font-size: 18px;
                padding: 10px 10px 10px 5px;
                display: block;
                border: none;
                border-bottom: 1px solid #757575;
            }

            #input:focus {
                outline: none;
            }

            /* LABEL ======================================= */

            .label {
                color: #999;
                font-size: 18px;
                font-weight: normal;
                position: absolute;
                pointer-events: none;
                left: 5px;
                top: 10px;
                transition: 0.2s ease all;
                -moz-transition: 0.2s ease all;
                -webkit-transition: 0.2s ease all;
            }

            /* active state */
            :host[focused] .label, :host[with-tags] .label {
                top: -20px;
                font-size: 14px;
                color: #5264AE;
            }

            /* BOTTOM BARS ================================= */

            .bar {
                position: relative;
                display: block;
            }

            .bar:before, .bar:after {
                content: '';
                height: 2px;
                width: 0;
                bottom: 1px;
                position: absolute;
                background: #5264AE;
                transition: 0.2s ease all;
                -moz-transition: 0.2s ease all;
                -webkit-transition: 0.2s ease all;
            }

            .bar:before {
                left: 50%;
            }

            .bar:after {
                right: 50%;
            }

            /* active state */
            :host[focused] #inputGroup ~ .bar:before, :host[focused] #inputGroup ~ .bar:after {
                width: 50%;
            }

            /* HIGHLIGHTER ================================== */

            .highlight {
                position: absolute;
                height: 60%;
                top: 25%;
                left: 0;
                right: 0;
                pointer-events: none;
                opacity: 0.5;
            }

            /* active state */
            :host[focused] #inputGroup ~ .highlight {
                -webkit-animation: inputHighlighter 0.3s ease;
                -moz-animation: inputHighlighter 0.3s ease;
                animation: inputHighlighter 0.3s ease;
            }

            /* ANIMATIONS ================ */

            @-webkit-keyframes inputHighlighter {
                from {
                    background: #5264AE;
                }
                to {
                    width: 0;
                    background: transparent;
                }
            }

            @-moz-keyframes inputHighlighter {
                from {
                    background: #5264AE;
                }
                to {
                    width: 0;
                    background: transparent;
                }
            }

            @keyframes inputHighlighter {
                from {
                    background: #5264AE;
                }
                to {
                    width: 0;
                    background: transparent;
                }
            }
        </style>

        <iron-a11y-keys id="a11y" target="[[target]]"
                        keys="[[delimiter]]"
                        stop-keyboard-event-propagation="true"
                        on-keys-pressed="_add"></iron-a11y-keys>

        <polymer-keydown code="8" on-keydown="_deleteLast" />

        <div on-tap="_focus" class="group" on-down="_mouseDown" on-up="_mouseUp">
            <div id="inputGroup">
                <template is="dom-repeat" items="{{tags}}" as="tag">
                    <span class="tag">{{tag}}
                        <iron-icon icon="clear" on-tap="_delete"></iron-icon>
                    </span>
                </template>
                <div id="input" contenteditable="true" on-focus="_updateFocus" on-blur="_updateFocus"></div>
            </div>

            <span class="highlight"></span>
            <span class="bar"></span>
            <span class="label">Name</span>
        </div>

    </template>

    <script>
        Polymer( {

            is: 'polymer-tags-input',

            properties: {
                tags: {
                    type  : Array,
                    notify: true,
                    value : ["test"]
                },

                delimiter: {
                    type : String,
                    value: ","
                },

                focused: {
                    type: Boolean,
                    reflectToAttribute: true
                },

                withTags: {
                    type: Boolean,
                    computed: 'hasTags(tags.*)',
                    reflectToAttribute: true
                },

                _clickInProgress: Boolean
            },

            _delete: function( evt ){
                console.log( "delete", evt );
                this.splice( 'tags', evt.model.index, 1 );
            },

            _focus: function( evt ){
                //console.log(evt);
                // do nothing if already focused or the click targeted a span.tag
                //if(!this.focused && evt.path[0] == this.$.inputGroup)
                this.$.input.focus();

            },

            _deleteLast: function( evt ){
                if( event.keyCode == 8 && !this.$.input.innerText ){
                    this.pop( 'tags' );
                }
            },

            _mouseDown: function(evt){
                console.log("click");
                this._clickInProgress = true;

            },

            _mouseUp: function(evt){
                console.log("un-click");
                this._clickInProgress = false;

            },

            _updateFocus: function(evt){
                console.log(evt.type);
                if(evt.type == "focus") this.focused = true;
                else if(!this._clickInProgress) this.focused = false;
            },

            hasTags: function(){
                return this.tags && this.tags.length > 0;
            },

            _add: function( evt, detail ){
                console.log( "add", evt );

                detail.keyboardEvent.preventDefault();

                var newTag = this.$.input.innerText.replace( this.delimiter, "" ).toLowerCase();
                console.log( "newtag", newTag );
                if( newTag && this.tags.indexOf( newTag ) == -1 ) this.push( 'tags', newTag );
                this.$.input.innerText = "";
            },


        } );
    </script>
</dom-module>
