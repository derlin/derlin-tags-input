<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link ref="import" href="../polymer-keydown/polymer-keydown.html"
<!--
`polymer-tags-input`
an input especially for tags

@demo demo/index.html 
-->

<dom-module id="polymer-tags-input">
    <template>
        <style>
            :host {
                display: block;
                padding: 4px;
                width: 100%;
            }

            .tag {
                baackground-color: white;
                border: 1px solid #ababab;
                box-shadow: 2px 3px #eee;
                border-radius: 5px;
                padding: 0px 4px 2px 9px;
                margin-top: 5px;
                margin-right: 4px;
                font-size: .94em;
                display: inline-block;
            }

            .tag iron-icon {
                --iron-icon-height: 17px;
                --iron-icon-width: 17px;
                cursor: pointer;
            }

            :host[focused] .tag iron-icon {
                color: #5264AE;
                --iron-icon-height: 15px;
                --iron-icon-width: 15px;
            }

            #input {
                width: auto;
                display: inline-block;
                min-width: 30px;
                padding-left: 6px;
            }

            /* inspired from: https://codepen.io/sevilayha/pen/IdGKH  */

            .group {
                position: relative;
                margin-bottom: 45px;
                min-width: 200px;
                margin-top: 20px; /* space for the label */
                display: inline-block;
                width: 100%;
            }

            :host[expand] .group {
                width: auto;
            }


            #inputGroup {
                font-size: 18px;
                padding: 10px 10px 10px 5px;
                display: block;
                border: none;
                border-bottom: 1px solid #757575;
            }

            #input:focus {
                outline: none;
            }

            /* LABEL ======================================= */

            .label {
                color: #999;
                font-size: 18px;
                font-weight: normal;
                position: absolute;
                pointer-events: none;
                left: 5px;
                top: 10px;
                transition: 0.2s ease all;
                -moz-transition: 0.2s ease all;
                -webkit-transition: 0.2s ease all;
            }

            /* active state */
            :host[focused] .label, :host[has-tags] .label {
                top: -20px;
                font-size: 14px;
                color: #5264AE;
            }

            /* BOTTOM BARS ================================= */

            .bar {
                position: relative;
                display: block;
            }

            .bar:before, .bar:after {
                content: '';
                height: 2px;
                width: 0;
                bottom: 1px;
                position: absolute;
                background: #5264AE;
                transition: 0.2s ease all;
                -moz-transition: 0.2s ease all;
                -webkit-transition: 0.2s ease all;
            }

            .bar:before {
                left: 50%;
            }

            .bar:after {
                right: 50%;
            }

            /* active state */
            :host[focused] #inputGroup ~ .bar:before, :host[focused] #inputGroup ~ .bar:after {
                width: 50%;
            }

            /* HIGHLIGHTER ================================== */

            .highlight {
                position: absolute;
                height: 60%;
                top: 25%;
                left: 0;
                right: 0;
                pointer-events: none;
                opacity: 0.5;
            }

            /* active state */
            :host[focused] #inputGroup ~ .highlight {
                -webkit-animation: inputHighlighter 0.3s ease;
                -moz-animation: inputHighlighter 0.3s ease;
                animation: inputHighlighter 0.3s ease;
            }

            /* ANIMATIONS ================ */

            @-webkit-keyframes inputHighlighter {
                from {
                    background: #5264AE;
                }
                to {
                    width: 0;
                    background: transparent;
                }
            }

            @-moz-keyframes inputHighlighter {
                from {
                    background: #5264AE;
                }
                to {
                    width: 0;
                    background: transparent;
                }
            }

            @keyframes inputHighlighter {
                from {
                    background: #5264AE;
                }
                to {
                    width: 0;
                    background: transparent;
                }
            }
        </style>

        <iron-a11y-keys id="a11y" target="[[target]]"
                        keys="[[delimiter]]"
                        stop-keyboard-event-propagation="true"
                        on-keys-pressed="_add"></iron-a11y-keys>

        <polymer-keydown code="8" on-keydown="_deleteLast" />

        <div on-tap="_focus" class="group" on-down="_mouseDown" on-up="_mouseUp">
            <div id="inputGroup">
                <template is="dom-repeat" items="{{tags}}" as="tag">
                    <span class="tag">{{tag}}
                        <iron-icon icon="clear" on-tap="_delete"></iron-icon>
                    </span>
                </template>
                <div id="input" contenteditable="true" on-focus="_updateFocus" on-blur="_updateFocus"></div>
            </div>

            <span class="highlight"></span>
            <span class="bar"></span>
            <span class="label">[[label]]</span>
        </div>

    </template>

    <script>
        Polymer( {

            is: 'polymer-tags-input',

            properties: {
                /**
                 *  The array of tags. Tags are unique and lowercase.
                 */
                tags: {
                    type  : Array,
                    notify: true,
                    value : ["test"]
                },

                /**
                 * The label of the input. Labels will always float on focus.
                 */
                label: {
                    type: String,
                    value: 'Tags'
                },

                /**
                 * The delimiter used to detect a new tag. By default, a space will trigger
                 * a new tag insertion. Important: delimiters are a single character, more complex
                 * delimiters are not yet supported.
                 */
                delimiter: {
                    type : String,
                    value: ","
                },

                /**
                 * Whether or not the input is focused (read-only). Will reflect to attribute.
                 */
                focused: {
                    type: Boolean,
                    reflectToAttribute: true
                },

                /**
                 * True if the tags array is not empty (read-only). Will reflect to attribute.
                 */
                hasTags: {
                    type: Boolean,
                    computed: 'computeHasTags(tags.*)',
                    reflectToAttribute: true
                },

                /**
                 * Use this property to tune the display behavior of the input.
                 * If set to true, the input will be small at first and grow has needed (width: auto).
                 * If set to false, the input will always occupy all the available width (width: 100%).
                 * This property is set once.
                 */
                expand: {
                    type: Boolean,
                    reflectToAttribute: true
                },

                /*
                 * Keep track of clicks inside the element. This is important for the focus
                 * to work properly (see _updateFocus).
                 */
                _clickInProgress: Boolean
            },

            /*
             * Called when the element.delimiter is detected in the input.
             * Add a tag (if it does not already exist) and clear the input.
             */
            _add: function( evt, detail ){
                console.log( "add", evt );

                detail.keyboardEvent.preventDefault();

                var newTag = this.$.input.innerText.replace( this.delimiter, "" ).toLowerCase();
                console.log( "newtag", newTag );
                if( newTag && this.tags.indexOf( newTag ) == -1 ) this.push( 'tags', newTag );
                this.$.input.innerText = "";
            },

            /*
             * Called when a tag clear icon is clicked. Remove the tag from the tags array.
             */
            _delete: function( evt ){
                console.log( "delete", evt );
                this.splice( 'tags', evt.model.index, 1 );
            },

            /*
             * Called when a click occurs inside the shadow dom.
             * Gives focus to the input.
             */
            _focus: function( evt ){
                //console.log(evt);
                // do nothing if already focused or the click targeted a span.tag
                //if(!this.focused && evt.path[0] == this.$.inputGroup)
                this.$.input.focus();

            },

            /*
             * Called on keydown. If the backspace (keycode: 8) is pressed, remove
             * the last tag from the tags array.
             */
            _deleteLast: function( evt ){
                if( event.keyCode == 8 && !this.$.input.innerText ){
                    this.pop( 'tags' );
                }
            },

            /*
             * Called on input::focus() and input::blur(). Keep track of the focus
             * state of the input and update the host.focus property.
             * Note that blur is called whenever there is a mouse down. It is thus
             * important to ignore the event if the mouse is still inside the host
             * (_clickInProgress), to avoid focus/blur/focus sequence (weird visual effect).
             */
            _updateFocus: function(evt){
                console.log(evt.type);
                if(evt.type == "focus") this.focused = true;
                else if(!this._clickInProgress) this.focused = false;
            },

            /*
             * Keep track of clicks inside the element. This is important for the focus
             * to work properly (see _updateFocus).
             */
            _mouseDown: function(evt){
                console.log("click");
                this._clickInProgress = true;

            },

            /*
             * Keep track of clicks inside the element. This is important for the focus
             * to work properly (see _updateFocus).
             */
            _mouseUp: function(evt){
                console.log("un-click");
                this._clickInProgress = false;

            },

            /*
             * Computes the element.hasTags property based on the tags array length.
             */
            computeHasTags: function(){
                return this.tags && this.tags.length > 0;
            },


        } );
    </script>
</dom-module>
